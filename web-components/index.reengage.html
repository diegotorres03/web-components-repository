<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customer Engagement Index</title>
  <link href="https://dev.iconly.io/public/ShA4wc0jqRet/iconly.css" rel="stylesheet" />
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="style-tools.css">

  <!-- 
    [ ] header: generar div-user-info
    [ ] vista: login view
    [ ] Barra busqueda y paginaci칩n: top menu
    [ ] top menu debe esconderse seg칰n la vista
    [ ] top menu: Auto hide when is empty
  -->

  <style>

  </style>

</head>

<body>


  <event-stream>
    <event-group id="manual-event-btns">
      <event-source trigger="button[data-machine-event-name]" on="click"></event-source>
    </event-group>

    <!-- <event-source trigger="#login-form" on="accepted" data-machine-event-name="submit"></event-source> -->

  </event-stream>

  <nav class="flex-row">
    <!-- <button data-machine-event-name="load">load</button> -->
    <!-- <button data-machine-event-name="sessionActive">sessionActive</button>
    <button data-machine-event-name="login-sent">login-sent</button>
    <button data-machine-event-name="authenticated">authenticated</button> -->
  </nav>
  <!-- <state-machine id="toggle" initial-state="inactive" trigger="#state-toggle" on="click">
    <machine-context></machine-context>

    <machine-state id="inactive" on="TOGGLE" target="active"></machine-state>
    <machine-state id="active" on="TOGGLE" target="inactive"></machine-state>

  </state-machine> -->

  <script>
    const actions = Object.freeze({
      checkToken: async (ctx, event) => {
        console.log('checking session')
        const token = window.localStorage.getItem('token')
        if (!token) return { emit: 'noSession' }
        return { emit: 'sessionActive', data: { token } }
      },
      authenticate: async (ctx, event) => {
        console.group('authenticate')
        console.log('authenticate', event)
        const { email, password } = event
        console.table({ email, password })
        const res = await fetch('http://localhost:3000/authenticate', {
          method: 'POST',
          body: JSON.stringify({ email, password })
        })
        console.groupEnd()
        if (!res.ok) throw new Error('authenticationFailed')
        const authRes = await res.json()
        console.log('authRes', authRes)
        return new Promise(resolve => {
          setTimeout(() => {
            resolve({ emit: 'authenticated', data: authRes })
          }, 1_000)
        })
        // return { emit: 'authenticated', data: authRes }
      },

      saveSession: async (ctx, event) => {
        // alert('saving session')
        console.group('saveSession')
        console.log('event', event)
        console.log('context', ctx)
        console.groupEnd()
        const token = event.detail.data.token
        window.localStorage.setItem('token', token)
      },

      removeSessionToken: async () => {
        window.localStorage.removeItem('token')
      },

      logIn: async (ctx, event) => { },
      log: (ctx, event) => console.log('LOG:', ctx, event),
    })
  </script>

  <event-source id="on-load" trigger="window" on="load"></event-source>


  <state-machine visible id="ui-state-machine" initial-state="start" trigger="event-stream" on="data">
    <machine-context></machine-context>

    <machine-state id="start" action="checkToken">
      <machine-transition emit="sessionActive" target="idle"></machine-transition>
      <machine-transition emit="noSession" target="loginForm"></machine-transition>
    </machine-state>

    <!-- here the login modal opens and ask for email password convination -->
    <machine-state id="loginForm">
      <!-- <machine-transition on="submit" target="idle"></machine-transition> -->
      <machine-transition trigger="#login-form" on="accepted" emit="submit" target="authenticating"
        action="authenticate"></machine-transition>

      <!-- <machine-transition id="emitSubmit" emit="submit" target="idle" action="log"></machine-transition> -->
    </machine-state>

    <machine-state id="authenticating">
      <machine-transition emit="authenticated" target="idle" action="saveSession"></machine-transition>
      <machine-transition emit="authenticationFailed" target="start" action="log"></machine-transition>
    </machine-state>

    <machine-state id="idle" action="log">

      <machine-transition trigger="#logout-btn" on="click" emit="logout" target="loginForm"
        action="removeSessionToken"></machine-transition>
      <machine-transition emit="exit" target="end"></machine-transition>
    </machine-state>
    <machine-state id="end" type="final" action="log"></machine-state>

    <!-- <machine-state id="" on="" target=""></machine-state> -->

  </state-machine>


  <app-modal id="login-form" trigger="state-machine" on="loginForm">
    <h1 slot="title">Login</h1>
    <section slot="main" class="flex-row space-around">
      <div>
        <label for="login-email">email:</label>
        <input type="email" name="email" id="login-email">
        <br>
        <label for="login-password">password:</label>
        <input type="password" name="password" id="login-password">
      </div>
    </section>
  </app-modal>

  <script>

    const machine = document.querySelector('state-machine')

    machine.addEventListener('stateChanged', event => {
      console.log('stateChanged', event.detail.state)
      // console.log('state', state.value)
    })

    // machine.addEventListener('checkSession', event => {
    //   console.log('checking session')
    //   const token = window.localStorage.getItem('token')
    //   if (!token) machine.send({ type: 'noSession' })
    //   else machine.send({ type: 'sessionActive' })
    //   // console.log(event)
    // })

    // machine.addEventListener('loginForm', event => {
    //   console.log('ACTIVE')
    //   // console.log(event)
    // })
    // document.querySelector('#login-form')
    //   .addEventListener('accepted', event => {
    //     console.log('login info', event)
    //     const { email } = event.detail
    //     window.localStorage.setItem('token', email)
    //     setTimeout(() => {
    //       machine.send({ type: 'submit', data: { token: email } })
    //     }, 1_000)
    //   })


    // machine.addEventListener('')

  </script>


  <app-layout>

    <!-- Bot칩n que hace toggle al left-menu -->
    <div slot="header" class="header__div flex-row space-between">

      <span></span>
      <button id="login-btn" data-test-value="something">login</button>
      <button id="logout-btn">logout</button>

    </div>
    <!-- Imagen provisional de aws que est치 en el left-title -->
    <a slot="left-title" href="#"><img src="./landing-assets/AWS-logo.png" alt=""></a>
    <!-- Los navs dentro del left-content funcionan como un folder -->
    <nav slot="left-content">

      <details>
        <!-- Summary es el t칤tulo que aparecer치 en el details -->
        <summary>Dashboards</summary>
        <!-- links de ruta -->
        <a href="#area-dashboard">Area Dashboard </a>
        <a href="#">Caranti Toleda</a>
        <a href="#">Report Redox</a>
        <a href="#">Area Development</a>

      </details>

    </nav>
    <nav slot="left-content">

      <a href="#engagement-tracker">Engagement Tracker</a>

    </nav>
    <nav slot="left-content">

      <details>

        <summary>Visualization Tools</summary>
        <a href="#linksito">Area Revision</a>
        <a href="#">Larea Boreando</a>
        <a href="#">Permuta Cambuati</a>
        <a href="#">Leraneadoria</a>

      </details>

    </nav>

    <!-- MAIN  -->
    <app-router slot="main">

      <!-- 游낼 Home 游낼 -->
      <app-route>

        <h1>welcome</h1>

      </app-route>

      <!-- 游낼 Area-Dashboard 游낼 -->
      <app-route hash="area-dashboard">

        <article class="area-dashboard dashboard flex-column">

          <section class="header flex-row align-items-center justify-content-center">

            <h2 class="title"><strong>Area Name:</strong> US-CENTRAL</h2>

          </section>
          <section class="dashboard-section someclass flex-column ">

            <div class="dropdown-card">

              <div data-dropdown-header class="header flex-row align-items-center">

                <span class="icon-menu-down"></span>
                <h3 class="title">Strategic Engagement</h3>

              </div>
              <div class="item-container grid dropdown-toggle">

                <div class="item flex-column align-items-center">

                  <h3 class="title">Account Plan Complement</h3>
                  <div class="state-container ">
                    <input class="state-input" type="number" name="" id="">
                    <button class="state-btn clickable">+</button>
                  </div>

                </div>

              </div>

            </div>

          </section>

        </article>

      </app-route>

      <!-- 游낼 Engagement-Tracker 游낼 -->
      <app-route hash="engagement-tracker">

        <article class="engagement-tracker dashboard flex-column ">

          <section class="header flex-row align-items-center justify-content-between">

            <h1 class="title">Accounts (?)</h1>
            <input class="search" type="search" placeholder="Filter Accounts">

          </section>

          <section class="section costumer flex-row-between">

            <div class="card flex-column">

              <p class="item ">
                <span class="title">Costumer Name:</span>
                Papa tobias
              </p>
              <p class="item ">
                <span class="title">Territory: </span>
                ENT MiwestA05
              </p>
              <p class="item">
                <span class="title">District: </span>
                US Central ENT
              </p>

            </div>
            <div class="card flex-column">

              <p class="item">
                <span class="title">Costumer Segment Score:</span>
                45
              </p>
              <p class="item">
                <span class="title">Average NMU:</span>
                $2M
              </p>
              <p class="item">
                <span class="title">YoY Growth:</span>
                +34%
              </p>

            </div>

          </section>

          <section class="dashboard-section someclass flex-column ">

            <!-- Maybe tratar los dropdown como secciones en vez de cards -->
            <div class="dropdown-card flex-column">

              <div data-dropdown-header class="header flex-row align-items-center">

                <span class="icon-menu-down"></span>
                <h2 class="title">AWS Field Mechanism</h2>

              </div>

              <div class="item-container dropdown-toggle flex-column">

                <div class="item flex-row-between align-items-center">

                  <p class="title">Account map complete</p>
                  <div data-state-container class="state-container flex-row align-items-center">

                    <div class="state-btn-box flex-row align-items-center">

                      <button data-state-btn class="state-btn yes disabled ">

                        <span class="icon icon-check"></span>

                      </button>
                      <button data-state-btn class="state-btn no disabled">

                        <span class="icon icon-uncheck"></span>

                      </button>
                      <button data-state-btn class="state-btn ip disabled">

                        <span class="icon icon-in-process"></span>

                      </button>

                    </div>
                    <input class="state-input comment" name="comments" type="text" placeholder="Add Comment">
                    <button class="state-btn"><span class="icon icon-comment"></span></button>

                  </div>

                </div>


              </div>

            </div>

          </section>

        </article>

      </app-route>

      <app-route hash="linksito">

        <h1>Parranda</h1>

      </app-route>
      <app-route></app-route>

    </app-router>

  </app-layout>


  <script>
    const btn = document.querySelector('#hide-left')
    const left = document.querySelector('app-layout')
    let hidden = true
    console.log(left, btn)
    btn.addEventListener('click', event => {
      console.log(event, hidden)
      if (hidden) left.removeAttribute('hide-left')
      else left.setAttribute('hide-left', '')
      hidden = !hidden
    })
  </script>

  <script>

    // Obtener todos los encabezados de tarjetas con la clase "toggle-card__header"
    const headers = document.querySelectorAll("[data-dropdown-header]");

    // Funci칩n para agregar la clase "toggle-up", "rounded" y "roll"
    function toggleClass() {
      // Obtener el contenedor de la tarea asociado al encabezado clickeado
      const taskContainer = this.nextElementSibling;
      // Agregar la clase "toggle-up" al contenedor de la tarea
      taskContainer.classList.toggle("dropdown-toggle");

      // Agregar la clase "rounded" al encabezado clickeado
      this.classList.toggle("closed");

      // Obtener el elemento "icon-menu-down" dentro del encabezado clickeado
      const menuDown = this.querySelector(".icon-menu-down");
      // Agregar o quitar la clase "roll" al elemento "icon-menu-down"
      menuDown.classList.toggle("rotate");
    }

    // Asignar el evento clic a cada encabezado de tarjeta
    headers.forEach(function (header) {
      header.addEventListener("click", toggleClass);
    });

    const items = document.querySelectorAll("[data-state-container]");

    items.forEach(function (item) {
      const buttons = item.querySelectorAll("[data-state-btn]");
      let activeButton = null;

      buttons.forEach(function (button) {
        button.addEventListener("click", function () {
          if (activeButton !== null) {
            activeButton.classList.add("disabled");
          }
          this.classList.remove("disabled");
          activeButton = this;
        });
      });
    });




  </script>

</body>

</html>